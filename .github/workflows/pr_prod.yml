name: Pull Request CI

on:
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    name: Build & Lint ğŸ› ï¸
    env:
      GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
    steps:
      - uses: actions/checkout@v3
      - name: Install dependencies
        uses: ./.github/actions/install-with-cache
      - name: Build project
        run: npm run build
  integration-test:
    runs-on: ubuntu-latest
    name: Integration Tests ğŸ§ª
    needs:
      - build
    steps:
      - uses: actions/checkout@v3
      - name: Install dependencies
        uses: ./.github/actions/install-with-cache
      - name: Run tests
        run: npm run test
  trigger-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Trigger tests in flyttsmart-end-2-end-test repository
        id: trigger_workflow
        run: |
          repo_owner="flyttsmart"
          repo_name="flyttsmart-end-2-end-test"
          branch="main"

          echo "ğŸš€ Triggering tests in $repo_owner/$repo_name on branch $branch..."

          response=$(curl -L -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.PAT }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/repos/$repo_owner/$repo_name/actions/workflows/playwright.yml/dispatches \
            -d "{\"ref\": \"$branch\", \"inputs\": {\"domain\": \"mobile-flyttsmart\"}}")

  check-test-status:
    needs: trigger-tests
    runs-on: ubuntu-latest
    steps:
      - name: Wait for Test Completion
        run: |
          repo_owner="flyttsmart"
          repo_name="flyttsmart-end-2-end-test"
          branch="main"

          max_retries=68  # Checks for up to 17 minutes (68 * 15 seconds). The time flyttsmart takes to run the tests.
          wait_seconds=15
          attempt=0

          while [ $attempt -lt $max_retries ]; do
            attempt=$((attempt+1))
            echo "ğŸ”„ Attempt #$attempt: Checking test status..."

            response=$(curl -s -H "Authorization: Bearer ${{ secrets.PAT }}" \
              -H "Accept: application/vnd.github.v3+json" \
              https://api.github.com/repos/$repo_owner/$repo_name/actions/runs?branch=$branch)

            # Fetching the latest and updated commit from main branch
            status=$(echo $response | jq -r '.workflow_runs[0].status')
            conclusion=$(echo $response | jq -r '.workflow_runs[0].conclusion')

            echo "ğŸ” Status: $status"
            echo "ğŸ” Conclusion: $conclusion"

            if [ "$status" == "completed" ]; then
              if [ "$conclusion" == "success" ]; then
                echo "âœ… E2E tests passed!"
                exit 0
              else
                echo "âŒ E2E tests failed!"
                exit 1
              fi
            elif [ "$status" == "failure" ]; then
              echo "âŒ E2E tests failed!"
              exit 1
            fi

            echo "â³ Test not completed yet, waiting $wait_seconds seconds..."
            sleep $wait_seconds
          done

          echo "âŒ Timed out wait
